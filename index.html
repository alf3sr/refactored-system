<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport"
        content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>Point¬†Tracker</title>

  <!-- PWA + icons -->
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#000000">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="./Icon-192.png">

  <!-- Confetti + Sporty Font -->
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <style>
    /* ---------- themes ---------- */
    :root {
      --bg: #000; --panel-bg: #111; --panel-border: #333; --text: #fff;
      --pill-bg: #181818; --pill-br: #444; --pill-fg: #fff;
      --box: #000; --box-gap: 2px;
    }
    @media (prefers-color-scheme: light) {
      :root {
        --bg: #fff; --panel-bg: #f5f5f5; --panel-border: #ccc; --text: #000;
        --pill-bg: #eee; --pill-br: #bbb; --pill-fg: #000;
        --box: #fff;
      }
    }
    .light { --bg:#fff; --panel-bg:#f5f5f5; --panel-border:#ccc; --text:#000;
      --pill-bg:#eee; --pill-br:#bbb; --pill-fg:#000; --box:#fff;
    }
    .dark { --bg:#000; --panel-bg:#111; --panel-border:#333; --text:#fff;
      --pill-bg:#181818; --pill-br:#444; --pill-fg:#fff; --box:#000;
    }

    /* ---------- base ---------- */
    * { box-sizing: border-box; margin:0; padding:0; -webkit-tap-highlight-color: transparent; }
    body {
      height:100vh; background:var(--bg); color:var(--text);
      font-family: system-ui, sans-serif; overflow:hidden; touch-action: manipulation;
      user-select:none; -webkit-user-select:none; -webkit-touch-callout:none;
    }
    button { font: inherit; }
    .pill {
      padding:.45rem .9rem; border-radius:20px;
      background: var(--pill-bg); border:1px solid var(--pill-br); color:var(--pill-fg);
      cursor: pointer;
    }
    .pill:active { background: #222; }

    /* ---------- floating controls ---------- */
    #settingsBtn {
      position: fixed; top:1rem; right:1rem; z-index:90;
      width:2.6rem; height:2.6rem; display:flex; align-items:center; justify-content:center;
    }
    #cornerBtns {
      position: fixed; bottom:1rem; left:1rem; z-index:90;
      display:flex; gap:.7rem;
    }
    #timerBtn {
      position: fixed; bottom:1rem; right:1rem; z-index:90;
    }
    body.panel-open #cornerBtns,
    body.panel-open #timerBtn {
      opacity:0; pointer-events:none;
    }

    /* ---------- settings panel ---------- */
    #settingsPanel {
      position:fixed; top:0; right:0; width:340px; height:100%;
      background:var(--panel-bg); border-left:1px solid var(--panel-border);
      transform: translateX(100%); transition:.3s; padding:1rem;
      overflow-y:auto; z-index:80; scroll-behavior:smooth;
    }
    #settingsPanel.open { transform: translateX(0); }
    #settingsPanel h2 {
      margin-bottom:.7rem; font-size:1.2rem;
      border-bottom:1px solid var(--panel-border); padding-bottom:.4rem;
    }

    /* preview */
    #preview {
      display:grid; grid-template-columns:repeat(2,1fr);
      gap:.3rem; margin-bottom:.8rem;
    }
    .previewBox {
      padding:.4rem; text-align:center; font-size:.85rem;
      border-radius:6px; background:var(--box);
      border:1px solid var(--panel-border);
    }
    .previewBox span { display:block; font-weight:600; }

    /* rows */
    label.row {
      display:flex; align-items:center; margin:.55rem 0; font-size:.93rem;
    }
    label.row>span { flex:1; }
    .row input[type="text"],
    .row select {
      flex:1; padding:.35rem .55rem;
      background:#1a1a1a; border:1px solid #444; border-radius:6px;
      color: var(--text);
    }
    .light .row input[type="text"],
    .light .row select {
      background:#fff; border:1px solid #bbb; color:#000;
    }
    .row input[type="color"] {
      width:2rem; height:2rem; padding:0; border:none; background:none;
    }

    .swatchWrap { display:flex; gap:.25rem; margin-top:.25rem; }
    .swatch {
      width:1.2rem; height:1.2rem; border-radius:50%;
      border:1px solid #666; cursor:pointer;
    }

    .toggle {
      position:relative; width:40px; height:20px; margin-left:.6rem;
    }
    .toggle input { opacity:0; width:0; height:0; }
    .slider {
      position:absolute; inset:0; background:#444;
      border-radius:20px; transition:.2s;
    }
    .slider:before {
      content:""; position:absolute; left:2px; bottom:2px;
      width:16px; height:16px; background:var(--text);
      border-radius:50%; transition:.2s;
    }
    input:checked + .slider { background:#3498db; }
    input:checked + .slider:before {
      transform: translateX(20px);
    }

    .rangeRow {
      display:flex; align-items:center; gap:.6rem; font-size:.9rem;
    }
    .rangeRow input[type=range] { flex:1; }

    .statsBox {
      margin-top:1rem; border-top:1px solid var(--panel-border);
      padding-top:.8rem; font-size:.9rem;
    }
    .statsBox h3 {
      font-size:1rem; margin-bottom:.5rem;
    }

    /* ---------- court ---------- */
    #court {
      position:absolute; inset:0;
      display:grid; gap:var(--box-gap);
    }
    .teamBox {
      background:var(--box); display:flex; flex-direction:column;
      justify-content:center; align-items:center; cursor:pointer;
      padding:.4rem; transition:background .15s, transform .13s;
    }
    .teamBox:active { transform:scale(.96); }
    .teamName {
      font-size: clamp(4rem,10vw,6rem);
      font-family:'Bebas Neue',sans-serif;
    }
    .teamScore {
      font-size: clamp(8rem,20vmin,16rem);
      font-family:'Bebas Neue',sans-serif;
      transition:transform .25s;
    }
    .pop { transform:scale(1.35); }
    .leader {
      box-shadow:0 0 10px 4px currentColor inset;
    }

    /* ---------- overlays ---------- */
    #winnerBanner {
      position:absolute; inset:0; display:none;
      background:rgba(0,0,0,.8); z-index:95; color:#fff;
      font-size:2.4rem; font-weight:700;
      justify-content:center; align-items:center;
      flex-direction:column; text-align:center;
    }
    #winnerBanner button { margin-top:1rem; }

    /* clock */
    #matchTimer {
      position:fixed; top:1rem; left:50%;
      transform:translateX(-50%);
      font-size:1.2rem;
      font-family:'Bebas Neue',sans-serif;
      letter-spacing:.5px; z-index:89;
    }
    body.panel-open #matchTimer { opacity:0; }
  </style>
</head>

<body class="dark">

  <!-- clock -->
  <div id="matchTimer">00:00</div>

  <!-- floating controls -->
  <button id="settingsBtn" class="pill">‚öôÔ∏è</button>
  <div id="cornerBtns">
    <button id="undoBtn" class="pill">Undo</button>
    <button id="resetBtn" class="pill">Reset</button>
  </div>
  <button id="timerBtn" class="pill">‚èµ Timer</button>

  <!-- settings drawer -->
  <div id="settingsPanel">
    <h2>Settings</h2>
    <div id="preview"></div>

    <label class="row">
      <span>Countdown timer</span>
      <div class="toggle">
        <input type="checkbox" id="cdToggle"><span class="slider"></span>
      </div>
    </label>
    <div id="cdRow" class="rangeRow hidden">
      <span>min</span>
      <input type="range" id="cdRange" min="1" max="60">
      <span id="cdVal"></span>
    </div>

    <label class="row">
      <span>Theme</span>
      <select id="themeSel">
        <option value="auto">Auto</option>
        <option value="dark">Dark</option>
        <option value="light">Light</option>
      </select>
    </label>

    <label class="row">
      <span>Teams</span>
      <select id="teamCount">
        <option>2</option><option>3</option><option>4</option>
      </select>
    </label>

    <div id="teamsConfig"></div>

    <label class="row">
      <span>Points / tap</span>
      <select id="stepSel">
        <option>1</option><option>2</option><option>3</option><option>5</option>
      </select>
    </label>

    <label class="row">
      <span>Score limit</span>
      <div class="toggle">
        <input type="checkbox" id="limitToggle"><span class="slider"></span>
      </div>
    </label>
    <div id="limitRow" class="rangeRow hidden">
      <span>to</span>
      <input type="range" id="limitRange" min="1" max="100">
      <span id="limitVal"></span>
    </div>

    <div class="statsBox">
      <h3>Stats</h3>
      <div id="statsWrap"></div>
      <button id="resetStats" class="pill" style="margin-top:.6rem;display:none">
        Reset¬†stats
      </button>
    </div>
  </div>

  <!-- scoreboard + winner overlay -->
  <div id="court"></div>
  <div id="winnerBanner">
    <div id="winnerText">üèÜ Winner!</div>
    <button onclick="resetGame()" class="pill">New game</button>
  </div>

  <script>
    const $ = id => document.getElementById(id);
    const swatches = ['#3498db','#e74c3c','#9b59b6','#f1c40f','#1abc9c','#fff','#000'];
    const fmt = ms => {
      const s = Math.floor(ms/1000),
            m = Math.floor(s/60),
            ss = String(s%60).padStart(2,'0');
      return `${m}:${ss}`;
    };

    // initial state + persistence
    const seed = {
      teamCount:2,
      teams:[
        {name:'Team A',color:'#3498db',score:0},
        {name:'Team B',color:'#e74c3c',score:0}
      ],
      step:1,
      limitEnabled:false,
      limit:11,
      countdownEnabled:false,
      countdown:300000,
      timer:{running:false,start:0,elapsed:0},
      history:[], wins:{}, games:0, pointsTotal:0,
      theme:'auto'
    };
    let cfg = Object.assign(seed, JSON.parse(localStorage.getItem('pt-state')||'{}'));
    function save(){ localStorage.setItem('pt-state', JSON.stringify(cfg)); }

    // element refs
    const els = {
      panel: $('settingsPanel'), gear: $('settingsBtn'), preview: $('preview'),
      themeSel: $('themeSel'), teamCount: $('teamCount'), teams: $('teamsConfig'),
      stepSel: $('stepSel'),
      limitToggle: $('limitToggle'), limitRow: $('limitRow'),
      limitRange: $('limitRange'), limitVal: $('limitVal'),
      cdToggle: $('cdToggle'), cdRow: $('cdRow'),
      cdRange: $('cdRange'), cdVal: $('cdVal'),
      court: $('court'),
      undoBtn: $('undoBtn'), resetBtn: $('resetBtn'),
      timerBtn: $('timerBtn'), timerDisp: $('matchTimer'),
      winner: $('winnerBanner'), winnerText: $('winnerText'),
      statsWrap: $('statsWrap'), resetStats: $('resetStats')
    };

    // settings drawer toggle
    els.gear.addEventListener('click', ()=>{
      els.panel.classList.toggle('open');
      document.body.classList.toggle('panel-open',
        els.panel.classList.contains('open'));
    });

    // theme (auto/dark/light)
    function applyTheme(){
      const sys = window.matchMedia('(prefers-color-scheme:dark)').matches?'dark':'light';
      const mode = cfg.theme==='auto'? sys: cfg.theme;
      document.body.classList.remove('dark','light');
      document.body.classList.add(mode);
      els.themeSel.value = cfg.theme;
    }
    els.themeSel.oninput = e=>{ cfg.theme=e.target.value; applyTheme(); save(); };
    applyTheme();

    // render teams inputs
    function renderTeams(){
      cfg.teams.length = cfg.teamCount;
      cfg.teams = cfg.teams.map((t,i)=>
        t||{name:`Team ${String.fromCharCode(65+i)}`,color:swatches[i%swatches.length],score:0}
      );
      els.teams.innerHTML = '';
      cfg.teams.forEach((t,i)=>{
        els.teams.insertAdjacentHTML('beforeend',`
          <label class="row"><span>Team ${String.fromCharCode(65+i)}</span>
            <input type="text" id="name${i}" value="${t.name}">
          </label>
          <label class="row"><span style="visibility:hidden">Colour</span>
            <input type="color" id="clr${i}" value="${t.color}">
          </label>
          <div class="swatchWrap" id="sw${i}"></div>
        `);
        swatches.forEach(c=>{
          const dot=document.createElement('div');
          dot.className='swatch'; dot.style.background=c;
          dot.onclick=()=>{
            $(`clr${i}`).value=c;
            cfg.teams[i].color=c;
            updateCourt(); updatePreview(); save();
          };
          $(`sw${i}`).append(dot);
        });
      });
      updateCourt(); updatePreview(); save();
    }
    els.teamCount.value=cfg.teamCount;
    els.teamCount.oninput=e=>{ cfg.teamCount=+e.target.value; renderTeams(); };

    // live name/color edits
    els.teams.addEventListener('input', e=>{
      const m=e.target.id.match(/(name|clr)(\d+)/);
      if(!m) return;
      const i=+m[2];
      if(m[1]==='name') cfg.teams[i].name = e.target.value||`Team ${String.fromCharCode(65+i)}`;
      else cfg.teams[i].color = e.target.value;
      updateCourt(); updatePreview(); save();
    });

    // points/tap
    els.stepSel.value=cfg.step;
    els.stepSel.oninput=e=>{ cfg.step=+e.target.value; save(); };

    // score limit
    function syncLimitUI(){
      els.limitRow.classList.toggle('hidden', !els.limitToggle.checked);
      cfg.limitEnabled = els.limitToggle.checked; save();
    }
    els.limitToggle.checked=cfg.limitEnabled;
    els.limitToggle.onchange=syncLimitUI;
    els.limitRange.value=cfg.limit; els.limitVal.textContent=cfg.limit;
    els.limitRange.oninput=e=>{
      cfg.limit=+e.target.value;
      els.limitVal.textContent=e.target.value;
      save();
    };
    syncLimitUI();

    // countdown
    function syncCDUI(){
      els.cdRow.classList.toggle('hidden', !els.cdToggle.checked);
      cfg.countdownEnabled = els.cdToggle.checked;
      resetClock(); save();
    }
    els.cdToggle.checked=cfg.countdownEnabled;
    els.cdToggle.onchange=syncCDUI;
    els.cdRange.value=cfg.countdown/60000; els.cdVal.textContent=cfg.countdown/60000;
    els.cdRange.oninput=e=>{
      cfg.countdown=+e.target.value*60000;
      els.cdVal.textContent=e.target.value;
      resetClock(); save();
    };
    syncCDUI();

    // mini‚Äëpreview
    function updatePreview(){
      els.preview.innerHTML='';
      cfg.teams.forEach(t=>{
        els.preview.insertAdjacentHTML('beforeend',`
          <div class="previewBox" style="border:1px solid ${t.color}50">
            <span style="color:${t.color}">${t.name}</span>
            <small style="color:${t.color}">0</small>
          </div>`);
      });
    }

    // draw court
    function updateCourt(){
      els.court.style.gridTemplate = cfg.teamCount===2? '1fr 1fr / 1fr':'1fr 1fr / 1fr 1fr';
      els.court.innerHTML='';
      cfg.teams.forEach((t,i)=>{
        const box=document.createElement('div');
        box.className='teamBox'; box.dataset.i=i;
        box.innerHTML=`
          <div class="teamName" style="color:${t.color}">${t.name}</div>
          <div class="teamScore" style="color:${t.color}">${t.score}</div>`;
        box.addEventListener('pointerdown', e=>startPress(e,box));
        els.court.append(box);
      });
      updateScores(); highlightLeader();
    }
    function updateScores(){
      document.querySelectorAll('.teamScore').forEach((el,i)=>
        el.textContent=cfg.teams[i].score
      );
    }
    function highlightLeader(){
      const maxScore = Math.max(...cfg.teams.map(t=>t.score));
      document.querySelectorAll('.teamBox').forEach((box,i)=>{
        box.classList.toggle('leader',
          cfg.teams[i].score===maxScore && maxScore>0
        );
      });
    }

    // tap / long‚Äëpress
    let longTimer, longFired=false;
    function startPress(e,box){
      const idx=+box.dataset.i, step=cfg.step;
      longFired=false;
      longTimer=setTimeout(()=>{
        changeScore(idx,-step); longFired=true;
      },500);
      const up=()=>{
        clearTimeout(longTimer);
        if(!longFired) changeScore(idx,step);
        box.removeEventListener('pointerup',up);
        box.removeEventListener('pointercancel',up);
      };
      box.addEventListener('pointerup',up);
      box.addEventListener('pointercancel',up);
    }

    // change + pop animation
    function popAnim(box,color){
      const sc=box.querySelector('.teamScore');
      sc.classList.add('pop');
      setTimeout(()=>sc.classList.remove('pop'),250);
      box.animate([{background:color+'22'},{background:'transparent'}],{duration:250});
    }
    function changeScore(i,delta){
      cfg.teams[i].score = Math.max(0,cfg.teams[i].score+delta);
      cfg.history.push({team:i,delta});
      if(cfg.history.length>300) cfg.history.shift();
      updateScores();
      popAnim(els.court.children[i], cfg.teams[i].color);
      highlightLeader();
      haptic();
      checkWinner(i);
      save();
    }

    // undo & reset
    els.undoBtn.onclick=()=>{
      const last=cfg.history.pop(); if(!last) return;
      cfg.teams[last.team].score = Math.max(0,
        cfg.teams[last.team].score - last.delta
      );
      updateScores(); highlightLeader(); save();
    };
    function resetGame(){
      cfg.teams.forEach(t=>t.score=0);
      cfg.history=[];
      updateScores(); highlightLeader();
      els.winner.style.display='none';
      save();
    }
    els.resetBtn.onclick=resetGame;

    // winner & stats
    function checkWinner(i){
      if(cfg.limitEnabled && cfg.teams[i].score>=cfg.limit){
        confetti({particleCount:200,spread:70,startVelocity:45});
        els.winnerText.textContent = `üèÜ¬†${cfg.teams[i].name} wins!`;
        els.winner.style.display='flex';
        cfg.wins[cfg.teams[i].name] = (cfg.wins[cfg.teams[i].name]||0)+1;
        cfg.games++; cfg.pointsTotal += cfg.teams.reduce((s,t)=>s+t.score,0);
        renderStats(); save();
      }
    }
    function renderStats(){
      els.statsWrap.innerHTML='';
      Object.entries(cfg.wins).forEach(([n,w])=>{
        els.statsWrap.insertAdjacentHTML('beforeend',`<div>${n}:¬†${w}¬†wins</div>`);
      });
      if(cfg.games){
        const avg=(cfg.pointsTotal/cfg.games).toFixed(1);
        els.statsWrap.insertAdjacentHTML('beforeend',`<div>Avg pts/game:¬†${avg}</div>`);
        els.resetStats.style.display='';
      } else {
        els.resetStats.style.display='none';
      }
    }
    els.resetStats.onclick=()=>{
      cfg.wins={}; cfg.games=cfg.pointsTotal=0;
      renderStats(); save();
    };
    renderStats();

    // countdown timer
    function resetClock(){
      if(!cfg.countdownEnabled){
        els.timerDisp.textContent='00:00';
        els.timerBtn.style.display='none';
        return;
      }
      els.timerBtn.style.display='';
      cfg.timer.elapsed=cfg.countdown; cfg.timer.running=false;
      els.timerBtn.textContent='‚èµ Timer';
    }
    resetClock();
    els.timerBtn.onclick=()=>{
      if(!cfg.countdownEnabled) return;
      const t=cfg.timer;
      if(t.running){
        t.running=false;
        t.elapsed=Math.max(0,t.start+cfg.countdown-Date.now());
        els.timerBtn.textContent='‚èµ Timer';
      } else {
        t.running=true;
        t.start=Date.now()-(cfg.countdown-t.elapsed||0);
        els.timerBtn.textContent='‚è∏ Timer';
      }
      save();
    };
    (function loop(){
      const t=cfg.timer;
      if(t.running && cfg.countdownEnabled){
        const rem=Math.max(0,t.start+cfg.countdown-Date.now());
        els.timerDisp.textContent=fmt(rem);
        if(rem===0){t.running=false;confetti({particleCount:180,spread:100});}
      }
      requestAnimationFrame(loop);
    })();

    // prevent double‚Äëtap zoom
    let lastTouch=0;
    document.addEventListener('touchend',e=>{
      const now=e.timeStamp;
      if(now-lastTouch<300) e.preventDefault();
      lastTouch=now;
    },{passive:false});

    // haptic feedback
    let audioCtx;
    function haptic(){
      try{
        audioCtx=audioCtx||new(AudioContext||webkitAudioContext)();
        const osc=audioCtx.createOscillator(),
              g=audioCtx.createGain();
        osc.connect(g); g.connect(audioCtx.destination);
        osc.frequency.value=200; g.gain.value=0.8;
        osc.start(); osc.stop(audioCtx.currentTime+0.02);
      } catch{}
    }

    // initial render & service worker
    applyTheme();
    renderTeams();
    if('serviceWorker' in navigator){
      navigator.serviceWorker.register('./sw.js').catch(console.error);
    }
  </script>
</body>
</html>
