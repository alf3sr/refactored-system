<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <title>PointÂ Tracker</title>
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#000000">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="apple-touch-icon" href="./Icon-192.png">
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <style>
  /* ===== THEMES & BASE ===== */
  :root {
    --bg:#000; --fg:#fff; --panel:#111; --border:#333;
    --accent:#3498db; --box:#000; --gap:8px;
  }
  @media (prefers-color-scheme: light){
    :root {
      --bg:#fff; --fg:#000; --panel:#f5f5f5; --border:#ccc;
      --accent:#156fd1; --box:#fff;
    }
  }
  .light{--bg:#fff;--fg:#000;--box:#fff}
  .dark {--bg:#000;--fg:#fff;--box:#000}
  *{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
  body{
    height:100vh;background:var(--bg);color:var(--fg);
    font-family:system-ui,sans-serif;overflow:hidden;
    touch-action:manipulation;user-select:none;
  }
  button{font:inherit}
  .pill{
    padding:.6rem 1rem;border-radius:8px;
    background:var(--panel);border:1px solid var(--border);
    color:var(--fg);box-shadow:0 2px 10px rgba(0,0,0,0.25);
    transition: all .2s ease;
  }
  .pill:active{background:rgba(255,255,255,0.1)}

  /* SETTINGS GEAR */
  #settingsBtn{
    position:fixed;top:12px;right:12px;z-index:100;
    width:44px;height:44px;background:var(--panel);
    border:1px solid var(--border);border-radius:50%;
    display:flex;align-items:center;justify-content:center;
    box-shadow:0 2px 10px rgba(0,0,0,0.25);
  }

  /* DRAWER */
  #settingsPanel{
    position:fixed;top:0;right:0;width:300px;height:100%;
    background:var(--panel);border-left:1px solid var(--border);
    box-shadow:-2px 0 10px rgba(0,0,0,0.25);
    transform:translateX(100%);transition:transform .3s;
    padding:16px;overflow-y:auto;z-index:90;
  }
  #settingsPanel.open{transform:translateX(0)}
  #settingsPanel h2{
    font-size:1.3rem;margin-bottom:12px;
    border-bottom:1px solid var(--border);padding-bottom:8px;
  }

  /* LIVE PREVIEW */
  #preview{
    display:grid;gap:8px;margin-bottom:16px;
    grid-template-columns:repeat(auto-fit,minmax(80px,1fr));
  }
  .previewBox{
    background:var(--box);padding:8px;border-radius:8px;
    border:1px solid var(--border);text-align:center;
    font-size:.85rem;
  }
  .previewBox span{display:block;font-weight:600}

  /* ROWS & INPUTS */
  label.row{
    display:flex;align-items:center;font-size:1rem;margin:8px 0;
  }
  label.row>span{flex:1}
  .row input[type="text"],
  .row select{
    flex:1;padding:.5rem;background:var(--box);
    border:1px solid var(--border);border-radius:6px;
    color:var(--fg);transition:all .2s;
  }
  .row input[type="color"]{
    width:32px;height:32px;margin-left:8px;border:none;
  }

  /* TOGGLE */
  .toggle{position:relative;width:48px;height:28px;margin-left:8px}
  .toggle input{opacity:0;width:0;height:0}
  .slider{
    position:absolute;inset:0;background:var(--border);
    border-radius:14px;transition:background .2s;
  }
  .slider:before{
    content:"";position:absolute;top:4px;left:4px;
    width:20px;height:20px;border-radius:50%;
    background:var(--fg);transition:transform .2s;
  }
  input:checked+.slider{background:var(--accent)}
  input:checked+.slider:before{transform:translateX(20px)}

  /* SLIDER */
  .rangeRow{
    display:flex;align-items:center;gap:8px;
    font-size:1rem;margin:8px 0;
  }
  .rangeRow input[type=range]{
    flex:1;-webkit-appearance:none;background:transparent;
  }
  input[type=range]::-webkit-slider-runnable-track{
    height:4px;background:var(--border);border-radius:4px;
  }
  input[type=range]::-webkit-slider-thumb{
    -webkit-appearance:none;width:24px;height:24px;
    background:var(--accent);border-radius:50%;
    margin-top:-10px;box-shadow:0 2px 6px rgba(0,0,0,0.3);
    transition:all .2s;
  }

  /* STATS */
  .statsBox{
    margin-top:24px;border-top:1px solid var(--border);
    padding-top:16px;font-size:1rem;
  }
  .statsBox h3{font-size:1.2rem;margin-bottom:8px}

  /* COURT */
  #court{
    position:absolute;inset:0;display:grid;gap:var(--gap);
    transition:all .2s;
  }
  .teamBox{
    background:var(--box);
    display:flex;flex-direction:column;
    justify-content:center; /* centers name+score vertically */
    align-items:center;padding:12px;border-radius:8px;
    box-shadow:0 2px 10px rgba(0,0,0,0.25);
    transition:all .2s;
  }
  .teamBox:active{transform:scale(.97)}
  .teamName{
    font-size:clamp(3rem,8vw,5rem);
    font-family:'Bebas Neue',sans-serif;margin-bottom:8px;
  }
  .teamScore{
    font-size:clamp(6rem,15vw,12rem);
    font-family:'Bebas Neue',sans-serif;
    transition:transform .2s ease;
  }
  .pop{transform:scale(1.3)}
  .leader{border:4px solid currentColor}

  /* OVERLAYS */
  #winnerBanner{
    position:absolute;inset:0;display:none;
    background:rgba(0,0,0,0.7);color:#fff;
    font-size:2rem;font-weight:700;
    justify-content:center;align-items:center;flex-direction:column;
  }
  #winnerBanner button{margin-top:16px}

  /* TIMER DISPLAY */
  #matchTimer{
    position:fixed;top:12px;left:50%;
    transform:translateX(-50%);
    font-family:'Bebas Neue',sans-serif;
    font-size:1.2rem;letter-spacing:.5px;z-index:100;
    transition:opacity .2s;
  }
  body.panel-open #matchTimer{opacity:0}

  /* FLOATING LEFT BAR */
  #floatbar{
    position:fixed;bottom:60px;left:12px;
    display:flex;flex-direction:column;gap:12px;z-index:100;
  }

  /* PREVENT DOUBLE-TAP ZOOM */
  html,body{touch-action:manipulation}
  </style>
</head>
<body class="dark">
  <!-- timer -->
  <div id="matchTimer">00:00</div>

  <!-- settings gear -->
  <button id="settingsBtn" class="pill">âš™ï¸</button>

  <!-- floating left bar -->
  <div id="floatbar">
    <button id="undoBtn" class="pill">â†©ï¸</button>
    <button id="resetBtn" class="pill">ğŸ”„</button>
    <button id="timerBtn" class="pill">â±</button>
  </div>

  <!-- settings drawer -->
  <div id="settingsPanel">
    <h2>Settings</h2>
    <div id="preview"></div>

    <!-- team count -->
    <label class="row">
      <span>NumberÂ ofÂ Teams</span>
      <select id="teamCount">
        <option>1</option><option>2</option><option>3</option><option>4</option>
      </select>
    </label>

    <!-- name + colour -->
    <div id="teamsConfig"></div>

    <!-- game rules -->
    <label class="row">
      <span>â•Â PointsÂ perÂ tap</span>
      <select id="stepSel"><option>1</option><option>2</option><option>3</option><option>5</option></select>
    </label>
    <label class="row">
      <span>ğŸ¯Â ScoreÂ limit</span>
      <div class="toggle"><input type="checkbox" id="limitToggle"><span class="slider"></span></div>
    </label>
    <div id="limitRow" class="rangeRow hidden">
      <input type="range" id="limitRange" min="1" max="100"><span id="limitVal"></span>
    </div>
    <label class="row">
      <span>â±Â CountdownÂ timer</span>
      <div class="toggle"><input type="checkbox" id="cdToggle"><span class="slider"></span></div>
    </label>
    <div id="cdRow" class="rangeRow hidden">
      <input type="range" id="cdRange" min="1" max="60"><span id="cdVal"></span>
    </div>
    <label class="row">
      <span>ğŸŒ—Â Theme</span>
      <select id="themeSel">
        <option value="auto">Auto</option>
        <option value="dark">Dark</option>
        <option value="light">Light</option>
      </select>
    </label>

    <!-- stats -->
    <div class="statsBox">
      <h3>Stats</h3>
      <div id="statsWrap"></div>
      <button id="resetStats" class="pill" style="display:none">ğŸ—‘ï¸</button>
    </div>
  </div>

  <!-- court & winner -->
  <div id="court"></div>
  <div id="winnerBanner">
    <div id="winnerText">ğŸ†Â Winner!</div>
    <button onclick="resetGame()" class="pill">â–¶ï¸Â NewÂ game</button>
  </div>

  <script>
  /* â€” Utilities & State â€” */
  const $ = id => document.getElementById(id);
  const defaults = ['#3498db','#e74c3c','#9b59b6','#f1c40f'];
  const fmt = ms => {
    const s = Math.floor(ms/1000),
          m = Math.floor(s/60),
          ss = String(s%60).padStart(2,'0');
    return `${m}:${ss}`;
  };

  const seed = {
    teamCount:2,
    teams:[
      {name:'TeamÂ A',color:'#3498db',score:0},
      {name:'TeamÂ B',color:'#e74c3c',score:0}
    ],
    step:1, limitEnabled:false, limit:11,
    countdownEnabled:false, countdown:300000,
    timer:{running:false,start:0,elapsed:0},
    history:[], wins:{}, games:0, pointsTotal:0,
    theme:'auto',
    startTime:Date.now(), leadChanges:0, previousLeader:-1
  };
  let cfg = Object.assign(seed, JSON.parse(localStorage.getItem('pt-state')||'{}'));
  function save(){ localStorage.setItem('pt-state',JSON.stringify(cfg)) }

  // sanitize & defaults
  cfg.teams = Array.from({length:cfg.teamCount}, (_,i) => {
    const t = cfg.teams[i]||{};
    return {
      name: t.name||`TeamÂ ${String.fromCharCode(65+i)}`,
      color: t.color||defaults[i],
      score: t.score||0
    };
  });
  cfg.startTime    ||= Date.now();
  cfg.leadChanges  ||= 0;
  cfg.previousLeader = (cfg.previousLeader>=0?cfg.previousLeader:-1);
  save();

  /* â€” Element refs â€” */
  const els = {
    gear:   $('settingsBtn'),
    panel:  $('settingsPanel'),
    preview:$('preview'),
    teamCount:$('teamCount'),
    teams:  $('teamsConfig'),
    stepSel:$('stepSel'),
    limitToggle:$('limitToggle'),
    limitRow:   $('limitRow'),
    limitRange: $('limitRange'),
    limitVal:   $('limitVal'),
    cdToggle:$('cdToggle'),
    cdRow:   $('cdRow'),
    cdRange: $('cdRange'),
    cdVal:   $('cdVal'),
    themeSel:$('themeSel'),
    undo:    $('undoBtn'),
    reset:   $('resetBtn'),
    timerBtn:$('timerBtn'),
    court:   $('court'),
    timerDisp:$('matchTimer'),
    winner:  $('winnerBanner'),
    winnerText:$('winnerText'),
    stats:   $('statsWrap'),
    resetStats:$('resetStats')
  };

  /* â€” Drawer toggle â€” */
  els.gear.onclick = ()=>{
    els.panel.classList.toggle('open');
    document.body.classList.toggle('panel-open', els.panel.classList.contains('open'));
  };

  /* â€” Theme â€” */
  function applyTheme(){
    const sys = window.matchMedia('(prefers-color-scheme:dark)').matches ? 'dark':'light';
    document.body.classList.toggle('light', cfg.theme==='light' || (cfg.theme==='auto'&&sys==='light'));
    document.body.classList.toggle('dark',  cfg.theme==='dark'  || (cfg.theme==='auto'&&sys==='dark'));
    els.themeSel.value = cfg.theme;
  }
  els.themeSel.onchange = e=>{
    cfg.theme = e.target.value; applyTheme(); save();
  };
  applyTheme();

  /* â€” Teams config & live preview â€” */
  function renderTeams(){
    // clamp length
    cfg.teams = Array.from({length:cfg.teamCount}, (_,i)=>{
      const p = cfg.teams[i]||{};
      return {
        name: p.name||`TeamÂ ${String.fromCharCode(65+i)}`,
        color:p.color||defaults[i], score:p.score||0
      };
    });
    // preview
    els.preview.innerHTML = '';
    cfg.teams.forEach(t=> {
      els.preview.insertAdjacentHTML('beforeend',
        `<div class="previewBox"><span style="color:${t.color}">${t.name}</span></div>`
      );
    });
    // config rows
    els.teams.innerHTML = '';
    cfg.teams.forEach((t,i)=>{
      els.teams.insertAdjacentHTML('beforeend', `
        <label class="row">
          <span>TeamÂ ${String.fromCharCode(65+i)}</span>
          <input type="text" id="name${i}" value="${t.name}">
          <input type="color" id="clr${i}" value="${t.color}">
        </label>
      `);
    });
    // name listeners
    els.teams.querySelectorAll('input[type="text"]').forEach(inp=>{
      inp.oninput = e=>{
        const i = +e.target.id.slice(4);
        cfg.teams[i].name = e.target.value || `TeamÂ ${String.fromCharCode(65+i)}`;
        updateCourt(); save();
      };
    });
    // colour listeners
    els.teams.querySelectorAll('input[type="color"]').forEach(inp=>{
      inp.oninput = e=>{
        const i = +e.target.id.slice(3);
        cfg.teams[i].color = e.target.value;
        updateCourt(); save();
      };
    });
    updateCourt(); save();
  }
  // teamCount change
  els.teamCount.value = cfg.teamCount;
  ;['input','change'].forEach(evt=>{
    els.teamCount.addEventListener(evt,e=>{
      cfg.teamCount = +e.target.value;
      renderTeams();
    });
  });

  /* â€” Rules UI â€” */
  els.stepSel.value = cfg.step;
  els.stepSel.onchange = e=>{ cfg.step=+e.target.value; save() };

  function syncLimit(){
    els.limitRow.classList.toggle('hidden',!els.limitToggle.checked);
    cfg.limitEnabled = els.limitToggle.checked; save();
  }
  els.limitToggle.checked=cfg.limitEnabled;
  els.limitToggle.onchange=syncLimit;
  els.limitRange.value=cfg.limit; els.limitVal.textContent=cfg.limit;
  els.limitRange.oninput = e=>{
    cfg.limit = +e.target.value; els.limitVal.textContent=e.target.value; save();
  };
  syncLimit();

  function syncCD(){
    els.cdRow.classList.toggle('hidden',!els.cdToggle.checked);
    cfg.countdownEnabled = els.cdToggle.checked; resetClock(); save();
  }
  els.cdToggle.checked=cfg.countdownEnabled;
  els.cdToggle.onchange=syncCD;
  els.cdRange.value=cfg.countdown/60000; els.cdVal.textContent=cfg.countdown/60000;
  els.cdRange.oninput = e=>{
    cfg.countdown = +e.target.value*60000;
    els.cdVal.textContent = e.target.value; resetClock(); save();
  };
  syncCD();

  /* â€” Draw / update court â€” */
  function updateCourt(){
    let tpl;
    switch(cfg.teamCount){
      case 1: tpl = '1fr / 1fr'; break;
      case 2: tpl = '1fr 1fr / 1fr'; break;
      case 3: tpl = '1fr 1fr 1fr / 1fr'; break;
      case 4: tpl = '1fr 1fr / 1fr 1fr'; break;
    }
    els.court.style.gridTemplate = tpl;
    els.court.innerHTML = '';
    cfg.teams.forEach((t,i)=>{
      const box = document.createElement('div');
      box.className='teamBox'; box.dataset.i=i;
      box.innerHTML=`
        <div class="teamName" style="color:${t.color}">${t.name}</div>
        <div class="teamScore" style="color:${t.color}">${t.score}</div>`;
      box.addEventListener('pointerdown',e=>startPress(e,box));
      els.court.append(box);
    });
    updateScores(); highlightLeader();
  }
  function updateScores(){
    document.querySelectorAll('.teamScore').forEach((el,i)=>{
      el.textContent = cfg.teams[i].score;
    });
  }
  function highlightLeader(){
    const max = Math.max(...cfg.teams.map(t=>t.score));
    const leaders = cfg.teams.map((t,i)=>t.score===max&&max>0?i:-1).filter(i=>i>=0);
    const tie = leaders.length>1;
    document.querySelectorAll('.teamBox').forEach((b,i)=>{
      b.classList.remove('leader');
      b.style.borderColor = '';
      if(leaders.includes(i)){
        b.classList.add('leader');
        if(tie){
          b.style.borderColor = document.body.classList.contains('light')?'#000':'#fff';
        }
      }
    });
    // count lead changes
    const newLead = leaders.length===1?leaders[0]:-1;
    if(cfg.previousLeader>=0 && newLead!==cfg.previousLeader){
      cfg.leadChanges++; save();
    }
    cfg.previousLeader=newLead;
  }

  /* â€” Tap / longâ€‘press â€” */
  let longId, wasLong=false;
  function startPress(e,box){
    const i = +box.dataset.i, st = cfg.step;
    wasLong = false;
    longId = setTimeout(()=>{
      changeScore(i,-st);
      wasLong = true;
    }, 500);
    const end = ()=>{
      clearTimeout(longId);
      if(!wasLong) changeScore(i, st);
      box.removeEventListener('pointerup',end);
      box.removeEventListener('pointercancel',end);
    };
    box.addEventListener('pointerup',end);
    box.addEventListener('pointercancel',end);
  }
  function changeScore(i,d){
    cfg.teams[i].score = Math.max(0, cfg.teams[i].score + d);
    cfg.history.push({team:i,delta:d});
    if(cfg.history.length>300) cfg.history.shift();
    updateScores(); highlightLeader(); haptic(); checkWin(i); save();
  }

  /* â€” Undo / Reset â€” */
  els.undo.onclick = ()=>{
    const h = cfg.history.pop();
    if(!h) return;
    cfg.teams[h.team].score = Math.max(0, cfg.teams[h.team].score - h.delta);
    updateScores(); highlightLeader(); save();
  };
  function resetGame(){
    cfg.teams.forEach(t=>t.score=0);
    cfg.history=[]; updateScores(); highlightLeader();
    cfg.startTime=Date.now(); cfg.leadChanges=0; cfg.previousLeader=-1;
    els.winner.style.display='none';
    save();
  }
  els.reset.onclick = resetGame;

  /* â€” Win & Stats â€” */
  function checkWin(i){
    if(cfg.limitEnabled && cfg.teams[i].score>=cfg.limit){
      confetti({particleCount:200,spread:70,startVelocity:45});
      els.winnerText.textContent = `ğŸ†Â ${cfg.teams[i].name} wins!`;
      els.winner.style.display='flex';
      cfg.wins[cfg.teams[i].name] = (cfg.wins[cfg.teams[i].name]||0)+1;
      cfg.games++; cfg.pointsTotal+=cfg.teams.reduce((s,t)=>s+t.score,0);
      renderStats(); save();
    }
  }
  function renderStats(){
    els.stats.innerHTML='';
    // pts/tap
    els.stats.insertAdjacentHTML('beforeend',`<div><strong>Pts/tap:</strong> +${cfg.step}</div>`);
    // time
    const el = Date.now()-cfg.startTime,
          mm = Math.floor(el/60000),
          ss = String(Math.floor((el%60000)/1000)).padStart(2,'0');
    els.stats.insertAdjacentHTML('beforeend',`<div><strong>Time:</strong> ${mm}:${ss}</div>`);
    // lead changes
    els.stats.insertAdjacentHTML('beforeend',`<div><strong>Leads:</strong> ${cfg.leadChanges}</div>`);
    // wins & avg
    Object.entries(cfg.wins).forEach(([n,w])=>{
      els.stats.insertAdjacentHTML('beforeend',`<div>${n}:Â ${w} wins</div>`);
    });
    if(cfg.games){
      const avg=(cfg.pointsTotal/cfg.games).toFixed(1);
      els.stats.insertAdjacentHTML('beforeend',`<div>Avg/game:Â ${avg}</div>`);
      els.resetStats.style.display='';
    } else els.resetStats.style.display='none';
  }
  els.resetStats.onclick = ()=>{
    cfg.wins={}; cfg.games=cfg.pointsTotal=0; renderStats(); save();
  };
  renderStats();

  /* â€” Countdown â€” */
  function resetClock(){
    if(!cfg.countdownEnabled){
      els.timerDisp.textContent='00:00';
      els.timerBtn.style.display='none';
      return;
    }
    els.timerBtn.style.display='inline-block';
    cfg.timer.elapsed=cfg.countdown;
    cfg.timer.running=false;
    els.timerBtn.textContent='â±';
  }
  resetClock();
  els.timerBtn.onclick = ()=>{
    if(!cfg.countdownEnabled) return;
    const t=cfg.timer;
    if(t.running){
      t.running=false;
      t.elapsed=Math.max(0, t.start+cfg.countdown-Date.now());
      els.timerBtn.textContent='â±';
    } else {
      t.running=true;
      t.start=Date.now()-(cfg.countdown-t.elapsed||0);
      els.timerBtn.textContent='â¸';
    }
    save();
  };
  (function loop(){
    const t=cfg.timer;
    if(t.running && cfg.countdownEnabled){
      const r = Math.max(0, t.start+cfg.countdown-Date.now());
      els.timerDisp.textContent = fmt(r);
      if(r===0){ t.running=false; confetti({particleCount:180,spread:100}); }
    }
    requestAnimationFrame(loop);
  })();

  /* â€” Haptic click â€” */
  let audioCtx;
  function haptic(){
    try{
      audioCtx=audioCtx||new(AudioContext||webkitAudioContext)();
      const o=audioCtx.createOscillator(), g=audioCtx.createGain();
      o.connect(g); g.connect(audioCtx.destination);
      o.frequency.value=200; g.gain.value=.8;
      o.start(); o.stop(audioCtx.currentTime+.02);
    }catch{}
  }

  /* â€” Block doubleâ€‘tap zoom â€” */
  let last=0;
  document.addEventListener('touchend',e=>{
    const now=e.timeStamp;
    if(now-last<300) e.preventDefault();
    last=now;
  },{passive:false});

  /* â€” Initial render â€” */
  renderTeams();
  </script>
</body>
</html>
